---
# I don't think this frontmatter needs anything other than to exist so it is rendered through markdown
---
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="nfc-batch-uid-scanner" name="description">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>{{ site.github.source_branch }}</title>

    <style>
        body {
            margin: .5em 1em;
        }

        #batchControls {
            display: grid;
            grid-template-columns: repeat(3, minmax(max-content, 1fr));
            margin: 1em 0;
        }

        fieldset.wide {
            grid-column: 1 / -1;

            select, input {
                width: 100%;
            }
        }

        button,
        input,
        select {
            padding: .5em;
        }

        input[type="number"] {
            width: 3ch;
            text-align: center;
            padding-left: 0;
            padding-right: 0;
        }
    </style>
</head>

<body>

<div id="batchControls">
    <fieldset>
        <legend>Controls</legend>
        <div>
        <button id="start">ðŸŸ¢</button>
        <button id="stop" disabled>ðŸ”´</button>
        <button id="save" disabled>ðŸ’¾</button>
        </div>
    </fieldset>
    <fieldset>
        <legend><label for="batch">Batch #</label></legend>
        <div>
        <input type="number" id="batch" name="batch" value="1" />
        <button id="batchInc">+</button>
        <button id="batchDec">-</button>
        </div>
    </fieldset>
    <fieldset>
        <legend><label for="tag">Tag</label></legend>
        <input type="number" id="tag" name="tag" value="1" />
        <button id="tagInc">+</button>
        <button id="tagDec">-</button>
    </fieldset>
    <fieldset class="wide">
        <legend><label for="renderableType">Renderable Type</label></legend>
        <select id="renderableType" name="renderableType">
            <option value="App\Models\Tags\Pokemon">Pokemon</option>
            <option value="App\Models\Tags\PokemonForParents" selected>Pokemon for Parents</option>
        </select>
    </fieldset>
    <fieldset class="wide">
        <legend><label for="renderableId">Renderable Id</label></legend>
        <select id="renderableId" name="renderableId">
            <option data-name="Aiden Bayle" value="15">Aiden Bayle</option>
            <option data-name="Andrew Barnes" value="16">Andrew Barnes</option>
            <option data-name="Breck Sarber" value="1">Breck Sarber</option>
            <option data-name="Brendan Lawrence" value="19">Brendan Lawrence</option>
            <option data-name="Connor Killgore" value="20">Connor Killgore</option>
            <option data-name="Graham Johnson" value="6">Graham Johnson</option>
            <option data-name="Graham Sarber" value="14">Graham Sarber</option>
            <option data-name="Ian Worst" value="4">Ian Worst</option>
            <option data-name="Jack Laning" value="11">Jack Laning</option>
            <option data-name="Jordan Blum" value="3">Jordan Blum</option>
            <option data-name="Josh Ahrendt" value="2">Josh Ahrendt</option>
            <option data-name="Kaleb Barricklow" value="21">Kaleb Barricklow</option>
            <option data-name="Lucas Rivas" value="22">Lucas Rivas</option>
            <option data-name="Luke Meerman" value="8">Luke Meerman</option>
            <option data-name="Matthew Lawrence" value="7">Matthew Lawrence</option>
            <option data-name="Nolan Williams" value="9">Nolan Williams</option>
            <option data-name="Ryan Wiles" value="5">Ryan Wiles</option>
            <option data-name="Teagan Sorensen" value="18">Teagan Sorensen</option>
            <option data-name="Trevor Roehling" value="13">Trevor Roehling</option>
            <option data-name="Westin Wohlfert" value="12">Westin Wohlfert</option>
            <option data-name="William Hemmes" value="17">William Hemmes</option>
            <option data-name="Wyatt Clapp" value="10">Wyatt Clapp</option>
        </select>
    </fieldset>
</div>

<h3>{{ site.github.source.branch }} <small style="font-weight: 100;">{{ site.github.build_revision | slice: 0, 7 }}</small></h3>

<h4>Log</h4>
<pre id="output"></pre>

<h4>Captured Data (<span class="counter">0</span>)</h4>
<pre id="data"></pre>

<script>
    const Logger = {
        write: function () {
            let line = Array.prototype.slice.call(arguments).map(function (argument) {
                return typeof argument === 'string' ? argument : JSON.stringify(argument);
            }).join(' ');

            const content = document.querySelector('#output').textContent;
            document.querySelector('#output').textContent = line + '\n' + content;
        },

        writeData: function () {
            let line = Array.prototype.slice.call(arguments).map(function (argument) {
                return typeof argument === 'string' ? argument : JSON.stringify(argument);
            }).join(' ');

            const content = document.querySelector('#data').textContent;
            document.querySelector('#data').textContent = line + '\n' + content;
        },

        clear: function () {
            document.querySelector('#output').textContent = '';
        },
    };

    document.addEventListener('DOMContentLoaded', function () {
        if (!("NDEFReader" in window)) {
            Logger.write("Web NFC is not available. Use Chrome on Android.");
            return false;
        }

        const ndef = new NDEFReader();
        const dataMap = new Map();
        let counter = 0;
        let abort;

        // controls
        const startBtn = document.querySelector("#start");
        const stopBtn = document.querySelector("#stop");
        const saveBtn = document.querySelector("#save");
        // batch
        const batchInput = document.querySelector("#batch");
        const batchIncBtn = document.querySelector("#batchInc");
        const batchDecBtn = document.querySelector("#batchDec");
        // tag
        const tagInput = document.querySelector("#tag");
        const tagIncBtn = document.querySelector("#tagInc");
        const tagDecBtn = document.querySelector("#tagDec");
        // renderable fields
        const renderableType = document.querySelector("#renderableType");
        const renderableId = document.querySelector("#renderableId");
        // counters
        const counters = document.querySelectorAll(".counter");
        // sounds
        const successSound = new Audio("https://cdn.freesound.org/previews/654/654321_12315704-lq.mp3");
        const errorSound = new Audio("https://cdn.freesound.org/previews/554/554053_12315704-lq.mp3");

        batchIncBtn.addEventListener("click", incrementBatch);
        batchDecBtn.addEventListener("click", decrementBatch);
        tagIncBtn.addEventListener("click", incrementTag);
        tagDecBtn.addEventListener("click", decrementTag);

        startBtn.addEventListener("click", startScanning);
        stopBtn.addEventListener("click", stopScanning);
        saveBtn.addEventListener("click", saveData);

        ndef.addEventListener("reading", readingSuccess);
        ndef.addEventListener("readingerror", readingError);

        async function startScanning() {
            try {
                if (abort) {
                    abort.abort();
                }

                abort = new AbortController();

                await ndef.scan({
                    signal: abort.signal
                });

                stopBtn.disabled = false;
                startBtn.disabled = true;

                Logger.write("> Scanning started...");

            } catch (e) {
                Logger.write("> ERROR: " + e.message);
            }
        }

        async function stopScanning() {
            abort.abort();
            abort = undefined;

            stopBtn.disabled = true;
            startBtn.disabled = false;
        }

        async function readingSuccess({ serialNumber }) {
            if (dataMap.has(serialNumber)) {
                Logger.write(`> ERROR: Duplicate Serial Number: ${serialNumber}`);
                await errorSound.play();
                if (!confirm('Tag already in dataset, would you like to override? (keep the tag in position if you continue)')) {
                    return;
                }
            }

            try {
                // write the url + serial number to the tag
                await ndef.write(
                    {
                        records: [
                            {
                                recordType: "url",
                                data: `https://tags.hudsonvillewaterpolo.com/${serialNumber}`,
                            },
                        ]
                    },
                    { overwrite: true }
                );

            } catch (e) {
                Logger.write(`> ERROR: Failed to write ${e.message}`);
                await errorSound.play();
                return;
            }

            // successfully wrote the url, now save the data for export

            const data = {
                serialNumber,
                batch: batchInput.value,
                tag: tagInput.value,
                renderableType: renderableType.value,
                renderableId: renderableId.value
            };

            dataMap.set(serialNumber, data);

            Logger.write(`> Wrote Serial Number: ${serialNumber}`);
            Logger.writeData(JSON.stringify(data));

            incrementTag();
            incrementCounters();
            saveBtn.disabled = false;
            await successSound.play();
        }

        function readingError() {
            Logger.write("ERROR! Cannot read data from the NFC tag. Try another one?");
            errorSound.play();
        }

        async function saveData() {
            const name = prompt('What would you like it to be named?', 'scanned-tags.csv');
            if (!name) {
                return false;
            }

            const data = Array.from(dataMap.values());
            const csv = data
                .map(datum => {
                    return [datum.serialNumber, datum.batch, datum.tag, datum.renderableType, datum.renderableId].join(',');
                })
                .join("\n");

            const blob = new Blob([csv], {type: "text/csv"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = name;
            a.click();
            URL.revokeObjectURL(url);
        }

        function incrementCounters() {
            counter++;
            counters.forEach(el => { el.textContent = '' + counter; });
        }

        function incrementBatch() {
            batchInput.value = parseInt(batchInput.value) + 1;
            tagInput.value = 1;
        }
        function decrementBatch() {
            batchInput.value = parseInt(batchInput.value) - 1;
        }

        function incrementTag() {
            tagInput.value = parseInt(tagInput.value) + 1;
        }
        function decrementTag() {
            tagInput.value = parseInt(tagInput.value) - 1;
        }
    });
</script>
</body>
</html>
